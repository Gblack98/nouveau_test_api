# ğŸ Image Python lÃ©gÃ¨re
FROM python:3.11-slim

# ğŸ§° Installer les dÃ©pendances systÃ¨me (OpenCV, libGL, etc.)
RUN apt-get update && \
    apt-get install -y libgl1 libglib2.0-0 && \
    rm -rf /var/lib/apt/lists/*

# ğŸ“‚ DÃ©finir le rÃ©pertoire de travail
WORKDIR /app

# ğŸ“¦ Installer les dÃ©pendances Python
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# ğŸ“ Copier uniquement les fichiers nÃ©cessaires Ã  l'API feuille
COPY api_feuille.py /app/api_feuille.py
COPY models/modele_feuille /app/models/modele_feuille

# ğŸ—‚ï¸ CrÃ©er les dossiers temporaires utilisÃ©s par l'app
RUN mkdir -p /tmp/pestai_crops /tmp/rebuilt_models

# ğŸŒ DÃ©clarer la variable d'environnement PORT (utile localement)
ENV PORT=8000

# ğŸš€ Lancer l'API avec un port dynamique compatible Render
CMD ["sh", "-c", "uvicorn api_feuille:app --host 0.0.0.0 --port ${PORT}"]
